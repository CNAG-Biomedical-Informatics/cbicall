# Overview

These pipelines extract mitochondrial reads from exome data and run **MToolBox** to generate mtDNA variant calls, annotations, and heteroplasmy estimates.

Two main modes:

- **mtDNA single-sample** (`mit_single`): analyze one sample at a time.
??? Example "See Bash pipeline:"

    ```bash
    --8<-- "https://raw.githubusercontent.com/CNAG-Biomedical-Informatics/cbicall/refs/heads/main/workflows/bash/gatk-3.5/mit_single.sh"
    ```

- **mtDNA cohort** (`mit_cohort`): analyze all samples in a family or cohort together.
??? Example "See Bash pipeline:"

    ```bash
    --8<-- "https://raw.githubusercontent.com/CNAG-Biomedical-Informatics/cbicall/refs/heads/main/workflows/bash/gatk-3.5/mit_cohort.sh"
    ```

Both operate on **WES single-sample outputs** and assume STSI-style naming conventions.


---

=== "Single-Sample"

    mtDNA Single-Sample Pipeline (`mit_single`)

    ## Diagram: mtDNA Single-Sample Workflow
    
    ??? Example "See diagram"

        ```mermaid
        flowchart TD
            A["Input WES BAM from single sample pipeline"]
            B["Extract mitochondrial reads chrM or MT"]
            C["Create mtDNA only BAM named with DNA_MIT suffix"]
            D["Run MToolBox using RSRS reference"]
            E["Obtain VCF file and prioritized variants text"]
            F["Parse variants and extract genotype depth and heteroplasmic fraction"]
            G["Write mit_prioritized_variants.txt for the sample"]
        
            A --> B --> C --> D --> E --> F --> G
        ```
    
    ---
    
    ## Purpose
    
    Run mtDNA analysis for a single individual starting from an exome BAM generated by the WES single-sample pipeline.
    
    Typical use cases:
    
    - Adding a new relative to an existing family workup.
    - Performing standalone mtDNA analysis for a single patient.
    
    ## Inputs and Assumptions
    
    - Executed from a directory named like: `cbicall_bash_mit_single_*`.
    - Exome BAM location:
    
      - `../../cbicall_bash_wes_single*/01_bam/input.merged.filtered.realigned.fixed.bam`
    
    - `parameters.sh` defines:
      - `REF` (used to choose `MT` vs `chrM`).
      - `SAM` (samtools path).
      - `MTOOLBOXDIR` (MToolBox install).
    - `MToolBox_config.sh` is copied from a shared `mtdna` directory.
    
    ## Step-by-Step
    
    ### 1. Extract mtDNA from Exome BAM
    
    - Determine mitochondrial contig name from `REF`:
      - If `REF` contains `b37`: use `MT`.
      - Otherwise: use `chrM`.
    - Extract mtDNA reads:
    
      - `samtools view -b <exome_bam> <MT/chrM> > <sample>-DNA_MIT.bam`
      - `samtools index <sample>-DNA_MIT.bam`
    
    ### 2. Run MToolBox
    
    - Add `MTOOLBOXDIR` to `PATH`.
    - Extend `PYTHONPATH` to include required Python site-packages.
    - Copy `MToolBox_config.sh` into the `MTOOLBOX/` working directory.
    - Run:
    
      - `MToolBox.sh -i MToolBox_config.sh -m "-t <THREADS>"`
    
    MToolBox:
    
    - Re-aligns to RSRS.
    - Calls mtDNA variants.
    - Annotates variants and haplogroups.
    - Produces:
      - `VCF_file.vcf`
      - `prioritized_variants.txt`
      - Other supporting files.
    
    ### 3. Append GT/DP/HF to Prioritized Variants
    
    - Use helper script `parse_var.pl` to convert variant IDs for matching.
    - For each variant in `prioritized_variants.txt`:
      - Find the corresponding row in `VCF_file.vcf` (chrMT + position).
      - Extract:
        - REF, ALT.
        - GT (genotype).
        - DP (depth).
        - HF (heteroplasmic fraction).
    - Append these fields to the original table.
    
    Final output:
    
    - `mit_prioritized_variants.txt` — prioritized variants plus GT/DP/HF.
    
    ## Key Output (Single Sample)
    
    | File                         | Description                                     |
    |------------------------------|-------------------------------------------------|
    | `VCF_file.vcf`               | mtDNA VCF from MToolBox                        |
    | `prioritized_variants.txt`   | MToolBox-prioritized variants                  |
    | `mit_prioritized_variants.txt` | Final variant list with GT/DP/HF appended     |
    
    ---
    
 
=== "Cohort"
 
    mtDNA Cohort Pipeline (`mit_cohort`)
 
    ## Diagram: mtDNA Cohort Workflow
    
    ??? Example "See diagram"
        ```mermaid
        flowchart TD
            A["Input all WES single sample directories in cohort"]
            B["Loop over samples and extract mtDNA BAM for each"]
            C["Collection of mtDNA BAM files"]
            D["Run MToolBox once for whole cohort"]
            E["Obtain cohort VCF file and prioritized variants text"]
            F["Subset and parse variants for all samples"]
            G["Write mit_prioritized_variants.txt for the cohort"]
     
            A --> B --> C --> D --> E --> F --> G
        ```
    
    ## Purpose
    
    Process **all samples in a cohort** and produce a joint mtDNA variant table, suitable for family analysis or maternal lineage studies.
    
    No WES cohort run is required; this pipeline only needs per-sample WES single outputs.
    
    ## Inputs and Assumptions
    
    - Executed from a directory named like: `cbicall_bash_mit_cohort_*` inside the cohort folder.
    - Expects subdirectories of the form:
    
      - `../../??????????_ex/cbicall_bash_wes_single*/01_bam`
    
    - `parameters.sh` defines `REF`, `SAM`, `MTOOLBOXDIR`.
    - `MToolBox_config.sh` exists in the shared `mtdna` directory.
    
    ## Step-by-Step
    
    ### 1. Extract mtDNA BAMs for All Samples
    
    - Loop over all WES single-sample `01_bam` directories.
    - For each sample:
      - Ensure BAM index name matches what MToolBox expects.
      - Choose mtDNA contig (`MT` vs `chrM`).
      - Extract and index `sample-DNA_MIT.bam`.
    
    Output: one mtDNA-only BAM per sample in the cohort.
    
    ### 2. Run MToolBox on the Cohort
    
    - As with the single-sample pipeline:
      - Update `PATH` and `PYTHONPATH`.
      - Copy `MToolBox_config.sh` locally.
    - Run MToolBox once over the full set of mtDNA BAMs.
    
    Outputs:
    
    - `VCF_file.vcf` (cohort).
    - `prioritized_variants.txt` (cohort).
    
    ### 3. Build Cohort Variant Table with HF
    
    - Use helper scripts:
      - `parse_var.pl` to prepare variant positions.
      - `parse_prioritized.pl` to summarize genotypes, depth, HF across samples.
    - Steps:
      - Create a temporary VCF containing only variants present in `prioritized_variants.txt`.
      - Run `parse_prioritized.pl` on this VCF.
      - Paste the parsed data onto `prioritized_variants.txt`.
    
    Final output:
    
    - `mit_prioritized_variants.txt` — cohort-level table with genotypes, depth, HF, and annotations.
    
    ## Key Output (Cohort)
    
    | File                         | Description                                             |
    |------------------------------|---------------------------------------------------------|
    | `VCF_file.vcf`               | Cohort mtDNA VCF from MToolBox                         |
    | `prioritized_variants.txt`   | Initial cohort prioritized variant list                |
    | `mit_prioritized_variants.txt` | Cohort variant table with GT/DP/HF and annotations   |
    
    ---
    
    ## When to Use These Pipelines
    
    ### Use `mit_single` when:
    
    - You have a new individual and you want mtDNA results quickly.
    - You need to re-run a single sample due to updated interpretation criteria.
    
    ### Use `mit_cohort` when:
    
    - You are analyzing mtDNA transmission in families.
    - You want a single table summarizing mtDNA variants across all cohort members.
    - You are preparing results for downstream statistical or segregation analysis.
    
